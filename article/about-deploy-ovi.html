<!DOCTYPE html><html><head><script>navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js?v=2822638e0b").then(e=>{if(!localStorage.getItem("installSW")){localStorage.setItem("installSW",!0);const t=setInterval(()=>{"activated"===e.active.state&&(clearInterval(t),fetch(window.location.href).then(e=>e.text()).then(e=>{document.open(),document.write(e),document.close()}))},100)}}).catch(console.log)</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="content-language" content="zh-CN"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>关于部署Onedrive-Vercel-Index的那些事 | 屑荧の小站</title><meta name="author" content="Lumine'blog"><meta name="copyright" content="Lumine'blog"><link rel="shortcut icon" href="https://static.lumine233.ml/Pic/avatar.webp"><meta name="keywords" content="Onedrive,Vercel"><meta name="description" content="Onedrive-Vercel-Index是一个OneDrive 公共目录索引 - 由 Vercel 与 Next.js 构建。 部署全程免费 配置时间小于15分钟 极快 且支持响应式布局 高度定制化 重要的是，它很漂亮！(●'◡'●)"><meta property="og:type" content="article"><meta property="og:title" content="关于部署Onedrive-Vercel-Index的那些事"><meta property="og:url" content="https://blog.lumine233.ml/article/about-deploy-ovi.html"><meta property="og:site_name" content="屑荧の小站"><meta property="og:description" content="Onedrive-Vercel-Index是一个OneDrive 公共目录索引 - 由 Vercel 与 Next.js 构建。 部署全程免费 配置时间小于15分钟 极快 且支持响应式布局 高度定制化 重要的是，它很漂亮！(●'◡'●)"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://static.lumine233.ml/Pic/avatar.webp"><meta property="article:published_time" content="2022-08-07T16:00:00.000Z"><meta property="article:modified_time" content="2022-08-07T16:00:00.000Z"><meta property="article:author" content="Lumine'blog"><meta property="article:tag" content="Onedrive"><meta property="article:tag" content="Vercel"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://static.lumine233.ml/Pic/avatar.webp"><link href="/third-party/fontawesome-free/css/all.min.css?v=3f5565600b" rel="stylesheet"><link href="/css/main.css?v=77884920af" rel="stylesheet"><script src="/js/utlis.js?v=a73b387a6f"></script><script>!function(){var e=mengd.$query("html");"true"===localStorage.isDark?e.setAttribute("theme","dark"):e.removeAttribute("theme")}()</script><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml?v=426cb0ace5" title="屑荧の小站" type="application/atom+xml"><link rel="alternate" href="/rss.xml?v=9c73fc8151" title="屑荧の小站" type="application/rss+xml"></head><body><script>var $config={CDN:{fancyboxJs:"/third-party/js/fancybox.js?v=881dd0c646",fancyboxCss:"/third-party/css/fancybox.css?v=25e637f333"},searchFile:"/search.json?v=e844149e27",codeBlockExpand:{enable:!0,height:400,scrollTop:200}}</script><div id="body-wrap"><nav id="nav-wrap"><div class="navbar"><div class="bar"><a href="/" class="title">屑荧の小站</a> <i class="fas fa-search search-btn"></i><ul class="menu"><li><a href="/">首页</a></li><li><a class="menu-child-hover" href="javascript:void(0);">找文章</a><ul class="menu-child"><li><a href="/tags">标签</a></li><li><a href="/categories">分类</a></li><li><a href="/archives">归档</a></li></ul></li><li><a href="/link">友情链接</a></li><li><a href="/about">关于我</a></li></ul><i class="fas fa-bars open-nav"></i></div></div><div id="mobile-nav"><ul><li><a href="/">首页</a></li><li><a href="/tags">标签</a></li><li><a href="/categories">分类</a></li><li><a href="/archives">归档</a></li><li><a href="/link">友情链接</a></li><li><a href="/about">关于我</a></li></ul></div></nav><header id="header"><div class="header-author"><a href="/" class="author"><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Pic/avatar.webp" alt="Lumine'blog" class="author-avatar"><div class="author-name">Lumine'blog</div></a></div><div class="header-description"><p>世界...遗忘我</p><div class="header-icon"><a href="mailto:Lumien@jiaran.tk" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope"></i></a> <a href="/rss.xml"><i class="fa fa-rss"></i></a></div></div></header><main id="main"><article id="post"><div class="post-info"><div class="post-title"><h1>关于部署Onedrive-Vercel-Index的那些事</h1></div><div class="post-meta"><div class="post-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i> <span class="post-meta-label">发表于 2022-08-08 | </span><i class="fas fa-history fa-fw post-meta-icon"></i> <span class="post-meta-label">更新于 2022-08-08</span></div><div class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i> <span class="post-meta-label">总字数:</span> <span class="word-count">1.4k | </span><i class="far fa-clock fa-fw post-meta-icon"></i> <span class="post-meta-label">阅读时长:</span> <span>5分钟</span> | <i class="far fa-eye fa-fw post-meta-icon"></i> <span class="post-meta-label">阅读量:</span> <span id="twikoo_visitors">0</span></div></div></div><div class="post-obsolete display-none" style="color:#d4b82a;background:#fcf9e1;border-left:5px solid #ffd818;border-right:5px solid #ffd818" limit_day="30" created="2022-08-08" updated="2022-08-08"><strong>文章时效性提醒:&nbsp;</strong>本文写作于 ${created} 天前，最后修订于 ${updated} 天前，其中的信息可能已经有所发展或者不再适用于现阶段。</div><div class="post-content"><blockquote><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://ovi.swo.moe/zh/docs/getting-started">官方文档</a>已经非常优秀了 <del>可我在部署的时候还是出现了很多问题</del> 这里来说一下我的部署过程[^本文部分内容来自官方文档]</p></blockquote><ol><li><p>Fork<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/spencerwooo/onedrive-vercel-index">这个</a>项目</p></li><li><p>修改配置文件</p><p><strong>虽然官方说只需要调整登录信息 但我实测 自建API的下载速度是要比官方API的快的</strong><del>(可能玄学)</del></p><ol><li><p>在 <code>site.config.js</code>替换 <code>spencer@spwoo.onmicrosoft.com</code> 为你的Onedrive邮箱 并修改<code>baseDirectory</code>为你想要共享的文件夹 (如果想共享根目录可不改动)</p></li><li><p>修改API为自建</p><p>注册应用程序</p><ul><li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade">Microsoft Azure App registrations</a>（ OneDrive 国际版、企业版与教育版，E5 订阅专用）</p></li><li><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://portal.azure.cn/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade">Microsoft Azure.cn App registrations</a>（OneDrive 世纪互联专用）</p><blockquote><p>随意输入一个名称 例如: My-OD-Key</p><p>受支持的账号类型 选择<code>任何组织目录(任何 Azure AD 目录 - 多租户)中的帐户和个人 Microsoft 帐户(例如，Skype、Xbox)</code>即可</p><p>重定向URI平台选择<code>WEB</code> 网址填入<code>http://localhost</code>即可</p><blockquote><p>完成后应如下图</p></blockquote><blockquote><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/d804c061c36c7b7b9089800b20cd6cf9.png" alt="完成后应如图"></p></blockquote><p>点击注册即完成</p></blockquote><p>获取你的 客户端ID 与 客户端Key</p></li><li><p>你的应用程序(客户端) ID 就是 <code>api.config.js</code> 里的 <code>clientId</code> ，它应该出现在 <em>概述</em> &gt; <em>概要</em></p><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/bcf05f063a0ff6404d1fd3310f18a1ce.png" alt="应用程序(客户端) ID"></p></li><li><p>你的 client secret (客户端密钥) 需要手动获取</p><blockquote><ol><li><p>点击 <em>证书与密码</em>。</p></li><li><p>点击 <em>新客户端密码</em></p></li><li><p>时间选择最长 名字随意</p><blockquote><p>完成后应如下图</p></blockquote><blockquote><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/990d609e02380ebd8dbaa74684b58fcd.png" alt="客户端密钥"></p></blockquote></li></ol><p>最后，点击 <em>添加</em> ，然后复制 client_secret 的值并妥善保管。<strong>（只有一次复制机会）</strong></p></blockquote></li></ul><p>修改API权限</p><blockquote><p>Microsoft Graph API 可以设置 API 范围，我们只需要以下三个（ <code>api.config.js</code> 里要求的）：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.read files.read.all offline_access</span><br></pre></td></tr></table></figure><blockquote><p>点击 <em>API权限</em>，再点击 <em>Microsoft Graph</em>，再点击 <em>委托的权限</em>，然后搜索：</p><blockquote><p>User.Read（这应该一开始就勾上了）</p></blockquote><blockquote><p>Files.Read.All</p></blockquote><blockquote><p>offline_access</p></blockquote></blockquote><blockquote><p>选择全部三个并点击 <em>更新权限</em>。</p><blockquote><p>完成后应如下图</p><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/81d2e1dc5c69712a34b51b098db07e74.png" alt="完成后应如图"></p></blockquote></blockquote></li></ol></li></ol><p>​ 现在，你就准备好你自己的 <code>clientId</code> 与 <code>clientSecret</code> 了。</p><ol start="3"><li><p>修改 <code>api.config.js</code></p><blockquote><p>你可以直接将 <code>clientId</code> 修改为你自己的 <code>clientId</code>。</p><p>但是，client secret 需要保密，你需要在<a target="_blank" rel="external nofollow noopener noreferrer" href="https://ovi.swo.moe/zh/docs/advanced#%E4%BF%AE%E6%94%B9-apiconfigjs">这里</a>进行 AES 加密</p></blockquote></li></ol><blockquote><p>填写 client secret 后，你应该得到一个长得像这样的字符串：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">U2FsdGVkX1830zo3/pFDqaBCVBb37iLw3WnBDWGF9GIB2f4apzv0roemp8Y+iIxI3Ih5ecyukqELQEGzZlYiWg==</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>将它替换到 <code>obfuscatedClientSecret</code> 里。</p></blockquote><blockquote><p>如果你修改了 <code>redirectUri</code> 为其他值，你也要在 <code>api.config.js</code> 里设置好。</p></blockquote><ol start="3"><li>导入到 Vercel 并部署</li></ol><blockquote><p>在 Vercel 导入 <strong>你自己的</strong> onedrive-vercel-index GitHub 项目，并进行以下设置：</p><ul><li><p>修改 Build command 为 <code>pnpm build</code>.</p></li><li><p>修改 Install command 为 <code>pnpm install</code>.</p><blockquote><p>完成后应如下图</p><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/1b60355421b1ceb2d5ca56c9426c6a37.png" alt="完成后应如图"></p></blockquote></li></ul><p>默认的也许能正常工作，但<strong>最好还是自定义这一项目</strong>。</p><p>然后点击部署，Vercel 将会下载你的项目并进行部署。这次部署有可能会失败，这是因为我们还没有设定 <code>REDIS_URL</code> 环境变量。这就是我们接下来要做的。</p></blockquote><ol start="4"><li>连接到 Redis</li></ol><blockquote><p>创建一个 Redis 数据库，并且将数据库的访问链接填写到 Vercel 的 <code>REDIS_URL</code> 环境变量里。Redis 数据库是用于存储在 OAuth 时获取的 <code>access_tokens</code> 与 <code>refresh_tokens</code> 的。</p><p>我们推荐使用 <strong>Upstash</strong> ，它完全免费，并且与 Vercel 深度合作，详情请参考 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.upstash.com/redis/howto/vercelintegration">Vercel Integration</a>。（请忽略最后一步时让你 <em>Create Your Redis Client</em> ，onedrive-vercel-index 已经为你处理好了）。</p><p>你可以使用你自己的 Redis 数据库，只要有 Vercel 能用的访问链接就行。</p><p>无论你用什么方式，你应该在 Vercel 的 <code>REDIS_URL</code> 环境变量里填好一个类似这样的 Redis URL：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis://:xxx...@some-thing-like-35533.upstash.io:35533</span><br></pre></td></tr></table></figure><blockquote><p>如果你为 Redis 数据库启用了 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.upstash.com/redis/howto/connectwithtls">传输加密</a>：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rediss://:xxx...@some-thing-like-35533.upstash.io:35533</span><br></pre></td></tr></table></figure><ol start="5"><li>重新部署</li></ol><blockquote><p>最后，重新进行一次部署。并在部署完成后访问 Vercel 提供的链接，<code>onedrive-vercel-index</code> 将会引导你进行 OAuth 认证。</p></blockquote><ol start="6"><li>进行认证</li></ol><blockquote><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/9c53ff97e14a0395903347a77094bca5.png" alt="Step 1 - preparing for authentication"></p><p>检查此页面上的参数是否正确，尤其是 <code>client_id</code> 与 <code>client_secret</code> （加密的），他们应该与你的项目里的一致。你还要检查一下 API 权限，应该只需要这三个：</p><blockquote><p><code>user.read</code>: 在进行 OAuth 时认证你的身份，防止某些傻逼通过重新认证雷普你的项目。</p><p><code>files.read.all</code>: 用于访问你的 OneDrive 的文件</p><p><code>offline_access</code>: 就是……用来离线访问 🙃</p></blockquote><p>如果一切都准备好了，就来到第二步。如果有些什么差错，检查你的 <code>config/api.config.js</code> 然后重新部署。</p></blockquote><ol start="7"><li><p>获取认证码</p><blockquote><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/9b0fc49fb4b54231750842613f39454c.png" alt="Step 2 - getting the authorisation code"></p><p>我们已经基于 <code>config/api.config.js</code> 给你准备好认证链接了。点击链接，你将会进入一个新标签页并进行登录。请确保你登陆的账户与你在 <code>config/site.config.js</code> 的 <code>userPrincipalName</code> 里设置的一致。</p><blockquote><p>完成登录后，你将会跳转到 <code>http://localhost</code> ，尽管它显示无法访问，你只需要复制地址栏中的地址然后粘贴到第二步的输入框里。onedrive-vercel-index 会自动识别用于获取 <code>access_token</code> 与 <code>refresh_token</code> 的认证码，然后点击 <em>Get tokens</em> 就行。</p></blockquote></blockquote></li><li><p>获取凭证</p><blockquote><p><img src="https://static.lumine233.ml/Pic/load.png" data-src="https://static.lumine233.ml/Img/2022/6896878bb479f21cd01bcffe4d43dcc5.png" alt="Success! We have acquired the tokens that are needed"></p><p>你只需要等待几秒钟，页面上就会显示成功提示以及几行凭证，请点击 <em>Store tokens</em> ，你的凭证就会保存到 Redis 数据库里。</p><blockquote><p>这个过程中我们一直在检查 <strong>你的身份</strong> ，所以如果出现了 “Don’t pretend to be the site owner” 提示，请检查<code>config/site.config.js</code> 里的 <code>userPrincipalName</code>是否填写正确。</p><blockquote><p>如果你认证结束后被重新跳转到步骤一，而你确认一切都没有问题时，<strong>请等待几秒并手动回到主页再刷新</strong>，Redis 数据库存取凭证需要一点儿时间。</p></blockquote></blockquote></blockquote></li></ol><p>最后，你将会跳转到属于你的全新 onedrive-vercel-index ，开始享受这一切 :) !<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://drive.lumine233.ml/zh-CN/">这是我自己搭建的Drive</a><br>如果有问题可以在评论区提问</p></div><div class="post-copyright"><div class="post-copyright-icon"></div><div class="post-copyright-author"><span class="post-copyright-meta">作者: </span><span class="post-copyright-info"><a href="mailto:Lumine@jiaran.tk" rel="external nofollow noopener noreferrer" target="_blank">流荧Lumine（荧）</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.lumine233.ml/article/about-deploy-ovi.html">https://blog.lumine233.ml/article/about-deploy-ovi.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="external nofollow noopener noreferrer">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.lumine233.ml/" target="_blank">屑荧の小站</a> !</span></div></div><div class="pagination-post"><a href="/article/Backup-miHoYo-Handbook.html"><div class="prev-title"><i class="fas fa-chevron-left"></i>【转载备份】米哈游员工手册</div><div class="prev-desc">来源：Bilibili https://space.bilibili.com/157554701 Violet-紫色闪电 本文仅作备份 米哈游是天堂，搞不好也是地狱 miHoYo是一个有着独特文化、理念以及做事行为喜好倾向的地方。尽曾这么听起来显得很不“专业”。相信在很多其他公司入职后会有人告诉你，公司大了，要学着与那些你不喜欢的人也能合作。</div></a><a href="/article/Fuck-Mihoyo.html"><div class="next-title">屑荧的艰苦抽卡历程<i class="fas fa-chevron-right"></i></div><div class="next-desc">屑荧抽卡的记录</div></a></div><div class="comment-head" id="直达评论"><hr><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div id="tcomment"></div><script>function LoadTwikoo(){mengd.getScript("https://cdn.jsdelivr.net/npm/twikoo@1.6.7/dist/twikoo.all.min.js",function(){twikoo.init(Object.assign({el:"#tcomment",envId:"https://api-chat.lumine233.ml/",region:"",path:location.pathname},{source:"https://cdn.jsdelivr.net/npm/twikoo@1.6.7/dist/twikoo.all.min.js",envId:"https://api-chat.lumine233.ml/"}))})}LoadTwikoo()</script></div></article></main></div><section id="rightside"><div class="rightside-item"><a href="javascript:void(0);" id="darkmode" title="深色/浅色 "><i class="fas fa-moon"></i> </a><a href="#直达评论" title="直达评论"><i class="fas fa-comments"></i> </a><a href="#" title="回到顶部"><i class="fas fa-arrow-up"></i></a></div></section><footer class="footer" id="footer"><div class="copyright">© 2022 <i class="fas fa-fan"></i> Lumine'blog</div><div class="framework-info"><span>框架</span> <a href="https://hexo.io" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> <span class="footer-separator">|</span> <span>主题 </span><a href="https://github.com/lete114/hexo-theme-MengD" target="_blank" rel="external nofollow noopener noreferrer">MengD.(萌典)</a></div><div class="custom-text">「为了未来，不能沉湎在美梦当中。又或者说，为了让人们有沉湎在美梦当中的余裕，必须有人醒过来，面对黎明前的黑暗。」<br><time id="timedate"></time><script>const time=mengd.getDaysDiffBetweenDates("2022-7-28");document.getElementById("timedate").innerText=`小站于各种崩坏中续存了${time}天`</script><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://icp.gov.moe/?keyword=20222284">萌ICP备20222284号</a></div></footer><div id="mask" onclick="closeAll()"></div><div id="local-search"><div id="local-search-title">本地搜索</div><input id="local-search-input" autocomplete="off" placeholder="搜索文章" type="text"><hr><div id="local-search-result"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><script src="/js/search.js?v=a0523e259c"></script><script src="/js/main.js?v=e948cc69e9"></script><script>var titleTime,originTitle=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="(つェ⊂) 我藏好了哦~ "+originTitle,clearTimeout(titleTime)):(document.title="(*´∇｀*) 被你发现啦~ "+originTitle,titleTime=setTimeout(function(){document.title=originTitle},2e3))})</script><script src="/js/lazyload.js?v=151b871c0e"></script><script>mengd.getScript("/third-party/js/prefetch-page.js?v=19a2c017da",()=>{const e=requestIdleCallback;e?e(()=>{prefetch({delay:1e3,threshold:25,customs:["/search.json?v=e844149e27"]})}):setTimeout(()=>{prefetch({delay:1e3,threshold:25,customs:["/search.json?v=e844149e27"]})},3e3)})</script></body></html>